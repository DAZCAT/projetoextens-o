name: Deploy Expo Web to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build Expo Web
        run: npx expo export --platform web

      # Detecta automaticamente a pasta de saída (dist, web-build ou build)
      - name: Detect export directory
        id: detect
        run: |
          if [ -d dist ]; then
            echo "BUILD_DIR=dist" >> $GITHUB_ENV
          elif [ -d web-build ]; then
            echo "BUILD_DIR=web-build" >> $GITHUB_ENV
          elif [ -d build ]; then
            echo "BUILD_DIR=build" >> $GITHUB_ENV
          else
            echo "Nenhuma pasta de build encontrada (dist/web-build/build)."
            ls -la
            exit 1
          fi
          echo "Usando pasta: ${BUILD_DIR:-unset}"

      # Patch: ajusta base path para o NOME EXATO do repositório (aqui: projetoextens-o)
      - name: Patch base path for GitHub Pages
        run: |
          sed -i 's|href="/|href="/projetoextens-o/|g' "$BUILD_DIR/index.html" || true
          sed -i 's|src="/|src="/projetoextens-o/|g'  "$BUILD_DIR/index.html" || true
          sed -i 's|<head>|<head><base href="/projetoextens-o/">|g' "$BUILD_DIR/index.html" || true

          # Prefixa caminhos nos JS
          find "$BUILD_DIR" -type f -name "*.js" -print0 | xargs -0 sed -i \
            -e 's|"/_expo/|"/projetoextens-o/_expo/|g' \
            -e 's|"/assets/|"/projetoextens-o/assets/|g'

          # metadata.json (se existir)
          if [ -f "$BUILD_DIR/metadata.json" ]; then
            sed -i 's|"/assets/|"/projetoextens-o/assets/|g' "$BUILD_DIR/metadata.json" || true
          fi

          # CSS com url('/assets/...') (se existir)
          find "$BUILD_DIR" -type f -name "*.css" -print0 | xargs -0 sed -i \
            -e "s|url('/assets/|url('/projetoextens-o/assets/|g" \
            -e 's|url("/assets/|url("/projetoextens-o/assets/|g'

      # SPA fallback
      - name: Copy 404.html for SPA fallback
        run: cp "$BUILD_DIR/index.html" "$BUILD_DIR/404.html"

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: '${{ secrets.GITHUB_TOKEN }}'
          publish_dir: ${{ env.BUILD_DIR }}
